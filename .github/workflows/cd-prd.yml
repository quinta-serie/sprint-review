name: CD - PRD
run-name: Deploy to "${{ inputs.project }}" by @${{ github.actor }}

on:
  workflow_dispatch:
    inputs:
      project:
        type: choice
        description: Choice a project
        required: true
        options:
          - client

jobs:
  setup:
    uses: ./.github/workflows/setup.yml
    with:
      BUILD_ENV: production
    secrets: inherit
  
  build-project:
    needs: [setup]
    uses: ./.github/workflows/projects.yml
    with:
      ENVIRONMENT: PROD
      BUILD_ENV: production
      PATH: dist
      PROJECT: ${{ inputs.project }}
      COMMAND: build
    secrets: inherit

  environment:
    needs: [build-project]
    runs-on: ubuntu-latest
    outputs:
      firebase_token: ${{ steps.firebase_token.outputs.value }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Get Firebase Token
        id: firebase_token
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: echo "value=$FIREBASE_TOKEN" >> $GITHUB_OUTPUT

  deploy-project:
    needs: [environment]
    uses: ./.github/workflows/deploy.yml
    with:
      ENVIRONMENT: PROD
      BUILD_ENV: production
      PATH: dist
      PROJECT: ${{ inputs.project }}
      FIREBASE_TOKEN: ${{ needs.environment.outputs.firebase_token }}
    secrets: inherit